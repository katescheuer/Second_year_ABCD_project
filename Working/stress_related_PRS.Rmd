---
title: "Stress-related PRS"
output: html_document
date: "2024-02-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("C:/Users/Kate Scheuer/OneDrive - UW/Desktop/Lab/Second_year_ABCD_project/Working")

```

### Import data, load libraries

```{r import data, load libraries, echo=FALSE}

### load libraries ####
library(readxl)
library(tidyverse)
library(GENESIS)
library(lme4)
library(Matrix)

### avoid scientific notation ####
options(scipen=999) ## forces full display of results, all digits
# to change it back to scientific notation, use: options(scipen=0)


### import data ####

## ABCD data
demo <- read.csv("abcd_p_demo.csv",header=T) # demographics
income <- read_xlsx("ABCD_SES_incomeneeds.xlsx")
meta <- read.csv("abcd_y_lt.csv",header=T) #site id, interview age
cbcl <- read.csv("mh_p_cbcl.csv",header=T) # cbcl
ksads_y <- read.csv("mh_y_ksads_ss.csv",header=T) #youth-reported ksads
ksads_p <- read.csv("mh_p_ksads_ss.csv",header=T) #parent-reported ksads

## PRS 
prs_no_mhc <- read.table("StressPRS.profile",header=T) #not including any snps in mhc
prs_one_mhc <- read.table("StressPRS_w_MHC.profile",header=T) #including one snp in mhc w highest effect size
prs_all_mhc <- read.table("StressPRS_w_one_MHC.profile",header=T) #include all snps in mhc

## genetic relatedness matrices (GRMs)
all_grm <- readRDS(file = "ABCD_All_PCRel_grm_sparse.rda") # all ancestries
afr_grm <- readRDS(file = "ABCD_Afr_PCRel_grm_sparse.rda") # african ancestry
amadmix_grm <- readRDS(file = "ABCD_AmerAdmix_PCRel_grm_sparse.rda") # american admixed ancestry
eur_grm <- readRDS(file = "ABCD_Eur_PCRel_grm_sparse.rda") # european ancestry

## ancestry groupings
afr_gp <- read_xlsx("ABCD_RF_Afr_Grouping.xlsx")
amadmix_gp <- read_xlsx("ABCD_RF_AmerAdmix_Grouping.xlsx")
eur_gp <- read_xlsx("ABCD_RF_Eur_Grouping.xlsx")

```

### Group all like files into one data frame each

```{r group data, echo=FALSE}

### rename income subjects to have subject id as abcd data
income <- income %>% rename(src_subject_id = subjectkey)

#youth ksads: all na - adhd baseline to year 2, adhd year 3+,
#                      ptsd baseline to year 2, pstd year 3+

### make one column each for ever having diagnosis ####
ksads <- select(ksads_y,c("src_subject_id","eventname",
                          
                         "ksads_14_854_t", # past adhd baseline to year 2
                         "ksads2_14_810_t", # past adhd year 3+
                         "ksads_14_853_t", # current adhd baseline to year 2
                         "ksads2_14_809_t", # current adhd year 3+
                         "ksads2_14_812_t", # full remission adhd year 3+
                         "ksads_14_855_t", # partial remission adhd baseline to year 2
                         "ksads2_14_811_t", # partial remission adhd year 3+
                         "ksads2_14_813_t", # other adhd year 3+
                         "ksads_14_856_t", # unspecified adhd baseline to year 2
                         
                         "ksads2_10_828_t", # past gad year 3+
                         "ksads2_10_827_t", # current gad year 3+
                         "ksads_10_870_t", # past gad baseline to year 2
                         "ksads_10_869_t", # current gad baseline to year 2
                         "ksads_10_913_t", # gad < min duration baseline to year 2
                         "ksads2_10_873_t", # gad < min duration year 3+
                         "ksads_10_914_t", # past gad < min duration baseline to year 2
                         "ksads2_10_874_t", # past gad < min duration year 3+
                         
                         "ksads_1_840_t", # current mdd baseline to year 2
                         "ksads2_1_790_t", # current mdd year 3+
                         "ksads_1_841_t", # partial remission mdd baseline to year 2
                         "ksads2_1_791_t", # partial remission mdd year 3+
                         "ksads_1_842_t", # past mdd baseline to year 2
                         "ksads2_1_792_t", # past mdd year 3+
                         
                         "ksads_21_922_t", # past ptsd baseline to year 2
                         "ksads2_21_883_t", # past ptsd year 3+
                         "ksads_21_921_t", # current ptsd baseline to year 2
                         "ksads2_21_881_t", # current ptsd year 3+
                         "ksads2_21_882_t" # partial remission ptsd year 3+
                         )) %>%
        left_join(
          select(ksads_p,c("src_subject_id","eventname",
                            "ksads_14_855_p", # partial remission adhd baseline to year 2
                            "ksads_14_854_p", # past adhd baseline to year 2
                            "ksads2_14_810_p", # past adhd year 3+
                            "ksads_14_853_p", # current adhd baseline to year 2
                            "ksads2_14_809_p", # currend adhd year 3+
                            "ksads2_14_812_p", # full remission adhd year 3+ 
                            "ksads2_14_811_p", # partial remission adhd year 3+ 
                            "ksads2_14_813_p", # other adhd year 3+ 
                            "ksads_14_856_p", # unspecified adhd baseline to year 2
                           
                            "ksads2_10_828_p", # past gad year 3+
                            "ksads2_10_827_p", # currend gad year 3+
                            "ksads_10_870_p", # past gad baseline to year 2
                            "ksads_10_869_p", # current gad baseline to year 2
                            "ksads_10_913_p", # gad < min duration baseline to year 2
                            "ksads_10_914_p", # past gad < min duration baseline to year 2
                            "ksads2_10_873_p", # gad < min duration year 3+
                            "ksads2_10_874_p", # past gad < min duration year 3+
                           
                            "ksads_1_841_p", # partial remission mdd baseline to year 2
                            "ksads_1_842_p", # past mdd baseline to year 2
                            "ksads_1_840_p", # current mdd baseline to year 2
                            "ksads2_1_790_p", # current mdd year 3+
                            "ksads2_1_791_p", # partial remission mdd year 3+
                            "ksads2_1_792_p", # past mdd year 3+
                           
                            "ksads_21_922_p", # past ptsd baseline to year 2
                            "ksads2_21_883_p", # past ptsd year 3+
                            "ksads_21_921_p", # current ptsd baseline to year 2
                            "ksads2_21_881_p", # current ptsd year 3+
                            "ksads2_21_882_p" # partial remission ptsd year 3+
                            )),
                  by=c("src_subject_id","eventname")) %>%
              mutate(adhd = case_when(
                                      ksads_14_854_t == 1 ~ 1,
                                      ksads_14_854_t == 0 ~ 0,
                                      ksads_14_854_t == 555 ~ NA,
                                      ksads_14_854_t == 888 ~ NA,
                                      ksads_14_854_t == NA ~ NA,
                                      
                                      ksads2_14_810_t == 1 ~ 1,
                                      ksads2_14_810_t == 0 ~ 0,
                                      ksads2_14_810_t == 555 ~ NA,
                                      ksads2_14_810_t == 888 ~ NA,
                                      ksads2_14_810_t == NA ~ NA,
                                      
                                      ksads_14_853_t == 1 ~ 1,
                                      ksads_14_853_t == 0 ~ 0,
                                      ksads_14_853_t == 555 ~ NA,
                                      ksads_14_853_t == 888 ~ NA,
                                      ksads_14_853_t == NA ~ NA,
                                      
                                      ksads2_14_809_t == 1 ~ 1,
                                      ksads2_14_809_t == 0 ~ 0,
                                      ksads2_14_809_t == 555 ~ NA,
                                      ksads2_14_809_t == 888 ~ NA,
                                      ksads2_14_809_t == NA ~ NA,
                                      
                                      ksads2_14_812_t == 1 ~ 1,
                                      ksads2_14_812_t == 0 ~ 0,
                                      ksads2_14_812_t == 555 ~ NA,
                                      ksads2_14_812_t == 888 ~ NA,
                                      ksads2_14_812_t == NA ~ NA,
                                      
                                      ksads_14_855_t == 1 ~ 1,
                                      ksads_14_855_t == 0 ~ 0,
                                      ksads_14_855_t == 555 ~ NA,
                                      ksads_14_855_t == 888 ~ NA,
                                      ksads_14_855_t == NA ~ NA,
                                      
                                      ksads2_14_811_t == 1 ~ 1,
                                      ksads2_14_811_t == 0 ~ 0,
                                      ksads2_14_811_t == 555 ~ NA,
                                      ksads2_14_811_t == 888 ~ NA,
                                      ksads2_14_811_t == NA ~ NA,
                                    
                                      ksads2_14_813_t == 1 ~ 1,
                                      ksads2_14_813_t == 0 ~ 0,
                                      ksads2_14_813_t == 555 ~ NA,
                                      ksads2_14_813_t == 888 ~ NA,
                                      ksads2_14_813_t == NA ~ NA,
                                      
                                      ksads_14_856_t == 1 ~ 1,
                                      ksads_14_856_t == 0 ~ 0,
                                      ksads_14_856_t == 555 ~ NA,
                                      ksads_14_856_t == 888 ~ NA,
                                      ksads_14_856_t == NA ~ NA,
                                      
                                      ksads_14_855_p == 1 ~ 1,
                                      ksads_14_855_p == 0 ~ 0,
                                      ksads_14_855_p == 555 ~ NA,
                                      ksads_14_855_p == 888 ~ NA,
                                      ksads_14_855_p == NA ~ NA,
                                      
                                      ksads_14_854_p == 1 ~ 1,
                                      ksads_14_854_p == 0 ~ 0,
                                      ksads_14_854_p == 555 ~ NA,
                                      ksads_14_854_p == 888 ~ NA,
                                      ksads_14_854_p == NA ~ NA,
                                      
                                      ksads2_14_810_p == 1 ~ 1,
                                      ksads2_14_810_p == 0 ~ 0,
                                      ksads2_14_810_p == 555 ~ NA,
                                      ksads2_14_810_p == 888 ~ NA,
                                      ksads2_14_810_p == NA ~ NA,
                                      
                                      ksads_14_853_p == 1 ~ 1,
                                      ksads_14_853_p == 0 ~ 0,
                                      ksads_14_853_p == 555 ~ NA,
                                      ksads_14_853_p == 888 ~ NA,
                                      ksads_14_853_p == NA ~ NA,
                                      
                                      ksads2_14_809_p == 1 ~ 1,
                                      ksads2_14_809_p == 0 ~ 0,
                                      ksads2_14_809_p == 555 ~ NA,
                                      ksads2_14_809_p == 888 ~ NA,
                                      ksads2_14_809_p == NA ~ NA,
                                      
                                      ksads2_14_812_p == 1 ~ 1,
                                      ksads2_14_812_p == 0 ~ 0,
                                      ksads2_14_812_p == 555 ~ NA,
                                      ksads2_14_812_p == 888 ~ NA,
                                      ksads2_14_812_p == NA ~ NA,
                                      
                                      ksads2_14_811_p == 1 ~ 1,
                                      ksads2_14_811_p == 0 ~ 0,
                                      ksads2_14_811_p == 555 ~ NA,
                                      ksads2_14_811_p == 888 ~ NA,
                                      ksads2_14_811_p == NA ~ NA,
                                      
                                      ksads2_14_813_p == 1 ~ 1,
                                      ksads2_14_813_p == 0 ~ 0,
                                      ksads2_14_813_p == 555 ~ NA,
                                      ksads2_14_813_p == 888 ~ NA,
                                      ksads2_14_813_p == NA ~ NA,
                                      
                                      ksads_14_856_p == 1 ~ 1,
                                      ksads_14_856_p == 0 ~ 0,
                                      ksads_14_856_p == 555 ~ NA,
                                      ksads_14_856_p == 888 ~ NA,
                                      ksads_14_856_p == NA ~ NA
                                      )) %>%
              mutate(gad = case_when(
                                     ksads2_10_828_t == 1 ~ 1,
                                     ksads2_10_828_t == 0 ~ 0,
                                     ksads2_10_828_t == 555 ~ NA,
                                     ksads2_10_828_t == 888 ~ NA,
                                     ksads2_10_828_t == NA ~ NA,
                                     
                                     ksads2_10_827_t == 1 ~ 1,
                                     ksads2_10_827_t == 0 ~ 0,
                                     ksads2_10_827_t == 555 ~ NA,
                                     ksads2_10_827_t == 888 ~ NA,
                                     ksads2_10_827_t == NA ~ NA,
                                     
                                     ksads_10_870_t == 1 ~ 1,
                                     ksads_10_870_t == 0 ~ 0,
                                     ksads_10_870_t == 555 ~ NA,
                                     ksads_10_870_t == 888 ~ NA,
                                     ksads_10_870_t == NA ~ NA,
                                     
                                     ksads_10_869_t == 1 ~ 1,
                                     ksads_10_869_t == 0 ~ 0,
                                     ksads_10_869_t == 555 ~ NA,
                                     ksads_10_869_t == 888 ~ NA,
                                     ksads_10_869_t == NA ~ NA,
                                     
                                     ksads_10_913_t == 1 ~ 1,
                                     ksads_10_913_t == 0 ~ 0,
                                     ksads_10_913_t == 555 ~ NA,
                                     ksads_10_913_t == 888 ~ NA,
                                     ksads_10_913_t == NA ~ NA,
                                     
                                     ksads2_10_873_t == 1 ~ 1,
                                     ksads2_10_873_t == 0 ~ 0,
                                     ksads2_10_873_t == 555 ~ NA,
                                     ksads2_10_873_t == 888 ~ NA,
                                     ksads2_10_873_t == NA ~ NA,
                                     
                                     ksads_10_914_t == 1 ~ 1,
                                     ksads_10_914_t == 0 ~ 0,
                                     ksads_10_914_t == 555 ~ NA,
                                     ksads_10_914_t == 888 ~ NA,
                                     ksads_10_914_t == NA ~ NA,
                                     
                                     ksads2_10_874_t == 1 ~ 1,
                                     ksads2_10_874_t == 0 ~ 0,
                                     ksads2_10_874_t == 555 ~ NA,
                                     ksads2_10_874_t == 888 ~ NA,
                                     ksads2_10_874_t == NA ~ NA,
                                     
                                     ksads2_10_828_p == 1 ~ 1,
                                     ksads2_10_828_p == 0 ~ 0,
                                     ksads2_10_828_p == 555 ~ NA,
                                     ksads2_10_828_p == 888 ~ NA,
                                     ksads2_10_828_p == NA ~ NA,
                                     
                                     ksads2_10_827_p == 1 ~ 1,
                                     ksads2_10_827_p == 0 ~ 0,
                                     ksads2_10_827_p == 555 ~ NA,
                                     ksads2_10_827_p == 888 ~ NA,
                                     ksads2_10_827_p == NA ~ NA,
                                     
                                     ksads_10_870_p == 1 ~ 1,
                                     ksads_10_870_p == 0 ~ 0,
                                     ksads_10_870_p == 555 ~ NA,
                                     ksads_10_870_p == 888 ~ NA,
                                     ksads_10_870_p == NA ~ NA,
                                     
                                     ksads_10_869_p == 1 ~ 1,
                                     ksads_10_869_p == 0 ~ 0,
                                     ksads_10_869_p == 555 ~ NA,
                                     ksads_10_869_p == 888 ~ NA,
                                     ksads_10_869_p == NA ~ NA,
                                     
                                     ksads_10_913_p == 1 ~ 1,
                                     ksads_10_913_p == 0 ~ 0,
                                     ksads_10_913_p == 555 ~ NA,
                                     ksads_10_913_p == 888 ~ NA,
                                     ksads_10_913_p == NA ~ NA,
                                     
                                     ksads_10_914_p == 1 ~ 1,
                                     ksads_10_914_p == 0 ~ 0,
                                     ksads_10_914_p == 555 ~ NA,
                                     ksads_10_914_p == 888 ~ NA,
                                     ksads_10_914_p == NA ~ NA,
                                     
                                     ksads2_10_873_p == 1 ~ 1,
                                     ksads2_10_873_p == 0 ~ 0,
                                     ksads2_10_873_p == 555 ~ NA,
                                     ksads2_10_873_p == 888 ~ NA,
                                     ksads2_10_873_p == NA ~ NA,
                                     
                                     ksads2_10_874_p == 1 ~ 1,
                                     ksads2_10_874_p == 0 ~ 0,
                                     ksads2_10_874_p == 555 ~ NA,
                                     ksads2_10_874_p == 888 ~ NA,
                                     ksads2_10_874_p == NA ~ NA,
                                     )) %>%
              mutate(mdd = case_when(
                                     ksads_1_840_t == 1 ~ 1,
                                     ksads_1_840_t == 0 ~ 0,
                                     ksads_1_840_t == 555 ~ NA,
                                     ksads_1_840_t == 888 ~ NA,
                                     ksads_1_840_t == NA ~ NA,
                                     
                                     ksads2_1_790_t == 1 ~ 1,
                                     ksads2_1_790_t == 0 ~ 0,
                                     ksads2_1_790_t == 555 ~ NA,
                                     ksads2_1_790_t == 888 ~ NA,
                                     ksads2_1_790_t == NA ~ NA,
                                     
                                     ksads_1_841_t == 1 ~ 1,
                                     ksads_1_841_t == 0 ~ 0,
                                     ksads_1_841_t == 555 ~ NA,
                                     ksads_1_841_t == 888 ~ NA,
                                     ksads_1_841_t == NA ~ NA,
                                     
                                     ksads2_1_791_t == 1 ~ 1,
                                     ksads2_1_791_t == 0 ~ 0,
                                     ksads2_1_791_t == 555 ~ NA,
                                     ksads2_1_791_t == 888 ~ NA,
                                     ksads2_1_791_t == NA ~ NA,
                                     
                                     ksads_1_842_t == 1 ~ 1,
                                     ksads_1_842_t == 0 ~ 0,
                                     ksads_1_842_t == 555 ~ NA,
                                     ksads_1_842_t == 888 ~ NA,
                                     ksads_1_842_t == NA ~ NA,
                                     
                                     ksads2_1_792_t == 1 ~ 1,
                                     ksads2_1_792_t == 0 ~ 0,
                                     ksads2_1_792_t == 555 ~ NA,
                                     ksads2_1_792_t == 888 ~ NA,
                                     ksads2_1_792_t == NA ~ NA,
                                     
                                     ksads_1_841_p == 1 ~ 1,
                                     ksads_1_841_p == 0 ~ 0,
                                     ksads_1_841_p == 555 ~ NA,
                                     ksads_1_841_p == 888 ~ NA,
                                     ksads_1_841_p == NA ~ NA,
                                     
                                     ksads_1_842_p == 1 ~ 1,
                                     ksads_1_842_p == 0 ~ 0,
                                     ksads_1_842_p == 555 ~ NA,
                                     ksads_1_842_p == 888 ~ NA,
                                     ksads_1_842_p == NA ~ NA,
                                     
                                     ksads_1_840_p == 1 ~ 1,
                                     ksads_1_840_p == 0 ~ 0,
                                     ksads_1_840_p == 555 ~ NA,
                                     ksads_1_840_p == 888 ~ NA,
                                     ksads_1_840_p == NA ~ NA,
                                     
                                     ksads2_1_790_p == 1 ~ 1,
                                     ksads2_1_790_p == 0 ~ 0,
                                     ksads2_1_790_p == 555 ~ NA,
                                     ksads2_1_790_p == 888 ~ NA,
                                     ksads2_1_790_p == NA ~ NA,
                                     
                                     ksads2_1_791_p == 1 ~ 1,
                                     ksads2_1_791_p == 0 ~ 0,
                                     ksads2_1_791_p == 555 ~ NA,
                                     ksads2_1_791_p == 888 ~ NA,
                                     ksads2_1_791_p == NA ~ NA,
                                     
                                     ksads2_1_792_p == 1 ~ 1,
                                     ksads2_1_792_p == 0 ~ 0,
                                     ksads2_1_792_p == 555 ~ NA,
                                     ksads2_1_792_p == 888 ~ NA,
                                     ksads2_1_792_p == NA ~ NA
                                     )) %>%
              mutate(ptsd = case_when(
                                      ksads_21_922_t == 1 ~ 1,
                                      ksads_21_922_t == 0 ~ 0,
                                      ksads_21_922_t == 555 ~ NA,
                                      ksads_21_922_t == 888 ~ NA,
                                      ksads_21_922_t == NA ~ NA,
                                      
                                      ksads2_21_883_t == 1 ~ 1,
                                      ksads2_21_883_t == 0 ~ 0,
                                      ksads2_21_883_t == 555 ~ NA,
                                      ksads2_21_883_t == 888 ~ NA,
                                      ksads2_21_883_t == NA ~ NA,
                                      
                                      ksads_21_921_t == 1 ~ 1,
                                      ksads_21_921_t == 0 ~ 0,
                                      ksads_21_921_t == 555 ~ NA,
                                      ksads_21_921_t == 888 ~ NA,
                                      ksads_21_921_t == NA ~ NA,
                                      
                                      ksads2_21_881_t == 1 ~ 1,
                                      ksads2_21_881_t == 0 ~ 0,
                                      ksads2_21_881_t == 555 ~ NA,
                                      ksads2_21_881_t == 888 ~ NA,
                                      ksads2_21_881_t == NA ~ NA,
                                      
                                      ksads2_21_882_t == 1 ~ 1,
                                      ksads2_21_882_t == 0 ~ 0,
                                      ksads2_21_882_t == 555 ~ NA,
                                      ksads2_21_882_t == 888 ~ NA,
                                      ksads2_21_882_t == NA ~ NA,
                                      
                                      ksads_21_922_p == 1 ~ 1,
                                      ksads_21_922_p == 0 ~ 0,
                                      ksads_21_922_p == 555 ~ NA,
                                      ksads_21_922_p == 888 ~ NA,
                                      ksads_21_922_p == NA ~ NA,
                                      
                                      ksads2_21_883_p == 1 ~ 1,
                                      ksads2_21_883_p == 0 ~ 0,
                                      ksads2_21_883_p == 555 ~ NA,
                                      ksads2_21_883_p == 888 ~ NA,
                                      ksads2_21_883_p == NA ~ NA,
                                      
                                      ksads_21_921_p == 1 ~ 1,
                                      ksads_21_921_p == 0 ~ 0,
                                      ksads_21_921_p == 555 ~ NA,
                                      ksads_21_921_p == 888 ~ NA,
                                      ksads_21_921_p == NA ~ NA,
                                      
                                      ksads2_21_881_p == 1 ~ 1,
                                      ksads2_21_881_p == 0 ~ 0,
                                      ksads2_21_881_p == 555 ~ NA,
                                      ksads2_21_881_p == 888 ~ NA,
                                      ksads2_21_881_p == NA ~ NA,
                                      
                                      ksads2_21_882_p == 1 ~ 1,
                                      ksads2_21_882_p == 0 ~ 0,
                                      ksads2_21_882_p == 555 ~ NA,
                                      ksads2_21_882_p == 888 ~ NA,
                                      ksads2_21_882_p == NA ~ NA
                                      )) %>%
              select(c("src_subject_id","eventname",
                       "adhd","gad","mdd","ptsd"))


## group all abcd data ####  
abcd_all <- demo %>%
              select(c("src_subject_id","eventname",
                       "demo_sex_v2","demo_gender_id_v2","demo_gender_id_v2_l",
                       "demo_comb_income_v2","demo_comb_income_v2_l")) %>%
              left_join(select(income,
                               c("src_subject_id","income_to_needs")),
                        by=c("src_subject_id")) %>%
              left_join(select(meta,
                               c("src_subject_id","eventname",
                                 "site_id_l","interview_age")),
                        by=c("src_subject_id","eventname")) %>%
              rename(site = site_id_l) %>%
              left_join(select(cbcl,
                               c("src_subject_id","eventname",
                                 "cbcl_scr_syn_aggressive_t","cbcl_scr_syn_attention_t",
                                 "cbcl_scr_syn_anxdep_t","cbcl_scr_syn_external_t",
                                 "cbcl_scr_syn_internal_t","cbcl_scr_syn_rulebreak_t",
                                 "cbcl_scr_syn_social_t","cbcl_scr_syn_somatic_t",
                                 "cbcl_scr_syn_thought_t","cbcl_scr_syn_totprob_t",
                                 "cbcl_scr_syn_withdep_t")),
                        by=c("src_subject_id","eventname")) %>%
              left_join(ksads,by=c("src_subject_id","eventname"))

prs_all <- prs_all_mhc %>%
              left_join(select(prs_one_mhc,c("SCORESUM","IID")),
                        by="IID") %>%
              rename(prs_all_mhc_val = SCORESUM.x,
                     prs_one_mhc_val = SCORESUM.y) %>%
              left_join(select(prs_no_mhc,c("SCORESUM","IID")),
                        by="IID") %>%
              rename(prs_no_mhc_val = SCORESUM) %>%
              select(c("IID","prs_all_mhc_val","prs_one_mhc_val","prs_no_mhc_val")) %>%
              rename(src_subject_id = IID)
prs_all$src_subject_id <- gsub("^.{1,10}","",prs_all$src_subject_id) #if remove first 10 char then = subject id as in abcd

## make categorical ancestry groups ####
afr_gp <- afr_gp %>% mutate(ancestry="Afr")
amadmix_gp <- amadmix_gp %>% mutate(ancestry="AmAdmix")
eur_gp <- eur_gp %>% mutate(ancestry="Eur")
ancestry_gp_all <- bind_rows(afr_gp,amadmix_gp,eur_gp) %>%
                      select("subjectkey","ancestry","V1","V2","V3","V4","V5","V6","V7","V8") %>%
                      rename(src_subject_id = subjectkey)

### rename grms so names are consistent with abcd names
#if remove first 10 char from rownames in grm then = subject id
rownames(all_grm) <- gsub("^.{1,10}","",rownames(all_grm)) 
colnames(all_grm) <- gsub("^.{1,10}","",colnames(all_grm))
rownames(afr_grm) <- gsub("^.{1,10}","",rownames(afr_grm))
colnames(afr_grm) <- gsub("^.{1,10}","",colnames(afr_grm))
rownames(amadmix_grm) <- gsub("^.{1,10}","",rownames(amadmix_grm))
colnames(amadmix_grm) <- gsub("^.{1,10}","",colnames(amadmix_grm))
rownames(eur_grm) <- gsub("^.{1,10}","",rownames(eur_grm))
colnames(eur_grm) <- gsub("^.{1,10}","",colnames(eur_grm))

### combine all data except grms ####
data_all <- abcd_all %>%
              left_join(prs_all, by="src_subject_id") %>%
              left_join(ancestry_gp_all, by="src_subject_id")

### remove subjects without ancestry information ####
data_all <- data_all %>% filter(!is.na(ancestry))

```

### Z-score PRS within each ancestry group

```{r z-score prs, echo=FALSE}

### Z-score all PRS ####
data_all <- data_all %>% 
          group_by(ancestry) %>%
          mutate(Zprs_all_mhc_val = as.numeric(scale(prs_all_mhc_val, scale=TRUE))) %>%
          mutate(Zprs_one_mhc_val = as.numeric(scale(prs_one_mhc_val, scale=TRUE))) %>%
          mutate(Zprs_no_mhc_val = as.numeric(scale(prs_no_mhc_val, scale=TRUE)))

### create column for PRS interactions with income-to-needs, sex, gender, age ####
data_all <- data_all %>%
          mutate(Zprsall_x_income = Zprs_all_mhc_val*income_to_needs) %>%
          mutate(Zprsall_x_sex = Zprs_all_mhc_val*demo_sex_v2) %>%
          mutate(Zprsall_x_gender = Zprs_all_mhc_val*demo_gender_id_v2_l) %>%
          mutate(Zprsall_x_age = Zprs_all_mhc_val*interview_age)

```

### Separate data based on collection date

``` {separate data based on collection date, r}

baseline_data <- data_all %>% filter(eventname == "baseline_year_1_arm_1")
yr1_data <- data_all %>% filter(eventname == "1_year_follow_up_y_arm_1")
yr2_data <- data_all %>% filter(eventname == "2_year_follow_up_y_arm_1")
yr3_data <- data_all %>% filter(eventname == "3_year_follow_up_y_arm_1")
yr4_data <- data_all %>% filter(eventname == "4_year_follow_up_y_arm_1")

```


### Reorder data so matches grm

```{reorder data so matches grm, r}

### All ancestries ####
all_grm_for_yr <- all_grm[which(rownames(all_grm) %in% yr4_data$src_subject_id),]
all_grm_for_yr <- all_grm_for_yr[,which(colnames(all_grm_for_yr) %in% yr4_data$src_subject_id)]
row_indices_All <- match(yr4_data$src_subject_id,rownames(all_grm_for_yr)) 
all_grm_sparse_subsetted <- all_grm_for_yr[row_indices_All, row_indices_All]
all_yr4_data_reordered <- yr4_data[match(colnames(all_grm_sparse_subsetted),yr4_data$src_subject_id),]
all_yr4_data_reordered <- all_yr4_data_reordered %>% column_to_rownames(var="src_subject_id")

### African ancestry ####
afr_grm_for_yr <- afr_grm[which(rownames(afr_grm) %in% yr4_data$src_subject_id),]
afr_grm_for_yr <- afr_grm_for_yr[,which(colnames(afr_grm_for_yr) %in% yr4_data$src_subject_id)]
row_indices_All <- match(yr4_data$src_subject_id,rownames(afr_grm_for_yr)) 
afr_yr4_data <- yr4_data %>% filter(ancestry=="Afr")
row_indices_All <- match(afr_yr4_data$src_subject_id,rownames(afr_grm_for_yr))
afr_grm_sparse_subsetted <- afr_grm_for_yr[row_indices_All, row_indices_All]
afr_yr4_data_reordered <- afr_yr4_data[match(colnames(afr_grm_sparse_subsetted),
                                                       afr_yr4_data$src_subject_id),]
afr_yr4_data_reordered <- afr_yr4_data_reordered %>% column_to_rownames(var="src_subject_id")

### American admixed ancestry ####
amadmix_for_yr <- amadmix_grm[which(rownames(amadmix_grm) %in% yr4_data$src_subject_id),]
amadmix_for_yr <- amadmix_for_yr[,which(colnames(amadmix_for_yr) %in% yr4_data$src_subject_id)]
row_indices_All <- match(yr4_data$src_subject_id,rownames(amadmix_for_yr)) 
amadmix_yr4_data <- yr4_data %>% filter(ancestry=="AmAdmix")
row_indices_All <- match(amadmix_yr4_data$src_subject_id,rownames(amadmix_for_yr))
amadmix_grm_sparse_subsetted <- amadmix_for_yr[row_indices_All, row_indices_All]
amadmix_yr4_data_reordered <- amadmix_yr4_data[match(colnames(amadmix_grm_sparse_subsetted),
                                                               amadmix_yr4_data$src_subject_id),]
amadmix_yr4_data_reordered <- amadmix_yr4_data_reordered %>% column_to_rownames(var="src_subject_id")


### European ancestry ####
eur_grm_for_yr <- eur_grm[which(rownames(eur_grm) %in% yr4_data$src_subject_id),]
eur_grm_for_yr <- eur_grm_for_yr[,which(colnames(eur_grm_for_yr) %in% yr4_data$src_subject_id)]
eur_yr4_data <- yr4_data %>% filter(ancestry=="Eur")
row_indices_All <- match(eur_yr4_data$src_subject_id,rownames(eur_grm_for_yr))
eur_grm_sparse_subsetted <- eur_grm_for_yr[row_indices_All, row_indices_All]
eur_yr4_data_reordered <- eur_yr4_data[match(colnames(eur_grm_sparse_subsetted),
                                                       eur_yr4_data$src_subject_id),]
eur_yr4_data_reordered <- eur_yr4_data_reordered %>% column_to_rownames(var="src_subject_id")

```

### Run grm and ancestry pc for all CBCL outcomes at yr4

``` {run grm and ancestry pc for all cbcl outcomes, r}

## run lin reg for each outcomes for each ancestry group ####
cbcl_outcome_list <- c("cbcl_scr_syn_aggressive_t","cbcl_scr_syn_attention_t",
                  "cbcl_scr_syn_anxdep_t","cbcl_scr_syn_external_t",
                  "cbcl_scr_syn_internal_t","cbcl_scr_syn_rulebreak_t",
                  "cbcl_scr_syn_social_t","cbcl_scr_syn_somatic_t",
                  "cbcl_scr_syn_thought_t","cbcl_scr_syn_totprob_t",
                  "cbcl_scr_syn_withdep_t" )
ancestry_list <- c("all","afr","amadmix","eur")
ancestry_data_list <- c("all_yr4_data_reordered",
                        "afr_yr4_data_reordered",
                        "amadmix_yr4_data_reordered",
                        "eur_yr4_data_reordered")
grm_list <- c("all_grm_sparse_subsetted","afr_grm_sparse_subsetted",
              "amadmix_grm_sparse_subsetted","eur_grm_sparse_subsetted")

for (ancestry in ancestry_list) {
  lm_cond_resid <- list() # initialize a list to store results  
  for (outcome in cbcl_outcome_list) {
  # Fit null models
  lm_model <- fitNullModel(get(ancestry_data_list[str_which(ancestry_data_list,ancestry)]), 
                           outcome = outcome, 
                           covars = c(
                                      # "Zprs_all_mhc_val",
                                      # "interview_age",
                                      # "demo_sex_v2",
                                      # "demo_gender_id_v2_l",
                                      # "income_to_needs",
                                      paste0("V", 1:8)
                                      # "Zprsall_x_income",
                                      # "Zprsall_x_sex",
                                      # "Zprsall_x_gender",
                                      # "Zprsall_x_age"
                                      ), 
                           cov.mat = get(grm_list[str_which(ancestry_data_list,ancestry)]), 
                           verbose = TRUE)

  # Store the fixef component with the first column as the outcome and variables
  lm_cond_resid[[outcome]] <- lm_model$fit %>%
                              rownames_to_column("id") %>%
                              select(c(id,resid.conditional))
  assign(paste0("lm_",ancestry,"_cbcl_results"),lm_cond_resid)
  }
}

## make long and wide dataframes for residuals for each ancestry group ####
lm_all_cond_resid_cbcl_long <- imap_dfr(lm_all_cbcl_results, ~mutate(.x, .id = .y))
lm_all_resid_cbcl <- lm_all_cond_resid_cbcl_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_afr_cond_resid_cbcl_long <- imap_dfr(lm_afr_cbcl_results, ~mutate(.x, .id = .y))
lm_afr_resid_cbcl <- lm_afr_cond_resid_cbcl_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_amadmix_cond_resid_cbcl_long <- imap_dfr(lm_amadmix_cbcl_results, ~mutate(.x, .id = .y))
lm_amadmix_resid_cbcl <- lm_amadmix_cond_resid_cbcl_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_eur_cond_resid_cbcl_long <- imap_dfr(lm_eur_cbcl_results, ~mutate(.x, .id = .y))
lm_eur_resid_cbcl <- lm_eur_cond_resid_cbcl_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)

```

### Run grm and ancestry pc regressions for KSADS outcomes at yr4

```{run grm and ancestry pc for all ksads outcomes, r}

## run lin reg for each outcomes for each ancestry group ####

#for year 4 did not converge for afr (n=2) or amadmix (n=3) adhd prob bc too few cases
# ksads_outcome_list <- c("adhd","gad","mdd","ptsd")
ksads_outcome_list <- c("gad","mdd","ptsd")
ancestry_list <- c("all","afr","amadmix","eur")
ancestry_data_list <- c("all_yr4_data_reordered",
                        "afr_yr4_data_reordered",
                        "amadmix_yr4_data_reordered",
                        "eur_yr4_data_reordered")
grm_list <- c("all_grm_sparse_subsetted","afr_grm_sparse_subsetted",
              "amadmix_grm_sparse_subsetted","eur_grm_sparse_subsetted")

for (ancestry in ancestry_list) {
  lm_cond_resid <- list() # initialize a list to store results  
  for (outcome in ksads_outcome_list) {
  # Fit null models
  lm_model <- fitNullModel(get(ancestry_data_list[str_which(ancestry_data_list,ancestry)]), 
                           outcome = outcome, 
                           covars = c(
                                      # "Zprs_all_mhc_val","interview_age",
                                      # "demo_sex_v2",
                                      # "demo_gender_id_v2_l",
                                      # "income_to_needs",
                                      paste0("V", 1:8)
                                      # "Zprsall_x_income",
                                      # "Zprsall_x_sex",
                                      # "Zprsall_x_gender",
                                      # "Zprsall_x_age"
                                      ), 
                           cov.mat = get(grm_list[str_which(ancestry_data_list,ancestry)]), 
                           verbose = TRUE,
                           family = "binomial")

  # Store the fixef component with the first column as the outcome and variables
  lm_cond_resid[[outcome]] <- lm_model$fit %>%
                              rownames_to_column("id") %>%
                              select(c(id,resid.conditional))
  assign(paste0("lm_",ancestry,"_ksads_results"),lm_cond_resid)
  }
}

## make long and wide dataframes for residuals for each ancestry group ####
lm_all_cond_resid_ksads_long <- imap_dfr(lm_all_ksads_results, ~mutate(.x, .id = .y))
lm_all_resid_ksads <- lm_all_cond_resid_ksads_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_afr_cond_resid_ksads_long <- imap_dfr(lm_afr_ksads_results, ~mutate(.x, .id = .y))
lm_afr_resid_ksads <- lm_afr_cond_resid_ksads_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_amadmix_cond_resid_ksads_long <- imap_dfr(lm_amadmix_ksads_results, ~mutate(.x, .id = .y))
lm_amadmix_resid_ksads <- lm_amadmix_cond_resid_ksads_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)
lm_eur_cond_resid_ksads_long <- imap_dfr(lm_eur_ksads_results, ~mutate(.x, .id = .y))
lm_eur_resid_ksads <- lm_eur_cond_resid_ksads_long %>%
  pivot_wider(names_from = .id, values_from = resid.conditional)

```


### Run regression for PRS and covariates for CBCL outcomes at yr4

``` {run regression for prs and covariates for cbcl, r}

## subset data for regression, combine with residuals from last regression ####
yr4_reg_data <- yr4_data %>%
                select(c("src_subject_id","demo_gender_id_v2_l",
                         "income_to_needs","site","interview_age",
                         "cbcl_scr_syn_aggressive_t","cbcl_scr_syn_attention_t",
                         "cbcl_scr_syn_anxdep_t","cbcl_scr_syn_external_t",
                         "cbcl_scr_syn_internal_t","cbcl_scr_syn_rulebreak_t",
                         "cbcl_scr_syn_social_t","cbcl_scr_syn_somatic_t",
                         "cbcl_scr_syn_thought_t","cbcl_scr_syn_totprob_t",
                         "cbcl_scr_syn_withdep_t",
                         "adhd","gad","mdd","ptsd",
                         "prs_all_mhc_val",
                         "ancestry")) %>%
                rename(
                  id = src_subject_id,
                  gender = demo_gender_id_v2_l,
                  age = interview_age,
                  raw_cbcl_aggress = cbcl_scr_syn_aggressive_t,
                  raw_cbcl_attn = cbcl_scr_syn_attention_t,
                  raw_cbcl_anxdep = cbcl_scr_syn_anxdep_t,
                  raw_cbcl_ext = cbcl_scr_syn_external_t,
                  raw_cbcl_int = cbcl_scr_syn_internal_t,
                  raw_cbcl_rule = cbcl_scr_syn_rulebreak_t,
                  raw_cbcl_social = cbcl_scr_syn_social_t,
                  raw_cbcl_somatic = cbcl_scr_syn_somatic_t,
                  raw_cbcl_thought = cbcl_scr_syn_thought_t,
                  raw_cbcl_total = cbcl_scr_syn_totprob_t,
                  raw_cbcl_withdep = cbcl_scr_syn_withdep_t,
                  raw_ksads_adhd = adhd,
                  raw_ksads_gad = gad,
                  raw_ksads_mdd = mdd,
                  raw_ksads_ptsd = ptsd,
                  prs = prs_all_mhc_val
                ) %>%
        left_join(lm_all_resid_cbcl,by="id") %>%
        left_join(lm_all_resid_ksads,by="id") %>%
        rename(
                resid_cbcl_aggress = cbcl_scr_syn_aggressive_t,
                resid_cbcl_attn = cbcl_scr_syn_attention_t,
                resid_cbcl_anxdep = cbcl_scr_syn_anxdep_t,
                resid_cbcl_ext = cbcl_scr_syn_external_t,
                resid_cbcl_int = cbcl_scr_syn_internal_t,
                resid_cbcl_rule = cbcl_scr_syn_rulebreak_t,
                resid_cbcl_social = cbcl_scr_syn_social_t,
                resid_cbcl_somatic = cbcl_scr_syn_somatic_t,
                resid_cbcl_thought = cbcl_scr_syn_thought_t,
                resid_cbcl_total = cbcl_scr_syn_totprob_t,
                resid_cbcl_withdep = cbcl_scr_syn_withdep_t,
                # resid_ksads_adhd = adhd,
                resid_ksads_gad = gad,
                resid_ksads_mdd = mdd,
                resid_ksads_ptsd = ptsd
        )

## make dummy and effect-coded versions of categorical variables ####
test <- yr4_reg_data %>%
          # make 777 and 999 in gender column NA
          mutate(gender = if_else(gender %in% c(777, 999), NA_real_, gender)) %>%
          dummy_cols(select_columns = c("gender"))
  
  
          recipe(~ gender) %>%
          step_dummy(all_nominal())
  
recipe_dummy <- recipe(~ gender, data = yr4_reg_data) %>%
  step_dummy(all_nominal())

# Apply the recipe to the data
dummy_coded_data <- bake(recipe_dummy, new_data = NULL)

          mutate(gender = as.factor(gender)) %>%
          modelr::dummy_cols()

gender
ancestry

        
# Intercept-Only Model Estimation (for Y) ----
cbcl_total_M0 <- lmer(resid_cbcl_total ~ 1 + (1|site), data=yr4_reg_data, REML=FALSE)
summary(cbcl_total_M0)
## computing the ICC for Y using variance components ----
variances = as.data.frame(VarCorr(cbcl_total_M0))
cluster_var = variances[1,'vcov']
resid_var = variances[2,'vcov']
ICC_Y2 <- cluster_var/(cluster_var + resid_var)
ICC_Y2

# Obtaining ICCs for L1 Predictors (Intercept-Only Model for X) ----
gender_M0 <- lmer(gender ~ (1|site), data=yr4_reg_data, REML=FALSE)
summary(gender_M0)
variances = as.data.frame(VarCorr(gender_M0))
cluster_var = variances[1,'vcov']
resid_var = variances[2,'vcov']
ICC_gender <- cluster_var/(cluster_var + resid_var)
ICC_gender

income_to_needs_M0 <- lmer(income_to_needs ~ (1|site), data=yr4_reg_data, REML=FALSE)
summary(income_to_needs_M0)
variances = as.data.frame(VarCorr(income_to_needs_M0))
cluster_var = variances[1,'vcov']
resid_var = variances[2,'vcov']
ICC_income_to_needs <- cluster_var/(cluster_var + resid_var)
ICC_income_to_needs

age_M0 <- lmer(age ~ (1|site), data=yr4_reg_data, REML=FALSE)
summary(age_M0)
variances = as.data.frame(VarCorr(age_M0))
cluster_var = variances[1,'vcov']
resid_var = variances[2,'vcov']
ICC_age <- cluster_var/(cluster_var + resid_var)
ICC_age

prs_M0 <- lmer(prs ~ (1|site), data=yr4_reg_data, REML=FALSE)
summary(prs_M0)
variances = as.data.frame(VarCorr(prs_M0))
cluster_var = variances[1,'vcov']
resid_var = variances[2,'vcov']
ICC_prs <- cluster_var/(cluster_var + resid_var)
ICC_prs

# Decomposing L1 Predictors ----
### start with dummy-coding ----
test <- yr4_reg_data %>%
          mutate(cis_female = case_when(
                                  gender == 1 ~ 0, #cis male
                                  gender == 2 ~ 1, #cis female
                                  gender == 3 ~ 0, #trans male
                                  gender == 4 ~ 0, #trans female
                                  gender == 5 ~ 0, #genderqueer
                                  gender == 6 ~ 0, #other
                                  gender == 777 ~ NA, #refuse
                                  gender == 999 ~ NA, #don't know
          )) %>%
          mutate(trans_male = case_when(
                                  gender == 1 ~ 0, #cis male
                                  gender == 2 ~ 0, #cis female
                                  gender == 3 ~ 1, #trans male
                                  gender == 4 ~ 0, #trans female
                                  gender == 5 ~ 0, #genderqueer
                                  gender == 6 ~ 0, #other
                                  gender == 777 ~ NA, #refuse
                                  gender == 999 ~ NA, #don't know
          )) %>%
          mutate(trans_female = case_when(
                                  gender == 1 ~ 0, #cis male
                                  gender == 2 ~ 0, #cis female
                                  gender == 3 ~ 0, #trans male
                                  gender == 4 ~ 1, #trans female
                                  gender == 5 ~ 0, #genderqueer
                                  gender == 6 ~ 0, #other
                                  gender == 777 ~ NA, #refuse
                                  gender == 999 ~ NA, #don't know
          )) %>%
          mutate(genderqueer = case_when(
                                  gender == 1 ~ 0, #cis male
                                  gender == 2 ~ 0, #cis female
                                  gender == 3 ~ 0, #trans male
                                  gender == 4 ~ 0, #trans female
                                  gender == 5 ~ 1, #genderqueer
                                  gender == 6 ~ 0, #other
                                  gender == 777 ~ NA, #refuse
                                  gender == 999 ~ NA, #don't know
          )) %>%
          mutate(other_gender = case_when(
                                  gender == 1 ~ 0, #cis male
                                  gender == 2 ~ 0, #cis female
                                  gender == 3 ~ 0, #trans male
                                  gender == 4 ~ 0, #trans female
                                  gender == 5 ~ 0, #genderqueer
                                  gender == 6 ~ 1, #other
                                  gender == 777 ~ NA, #refuse
                                  gender == 999 ~ NA, #don't know
          ))

income_to_needs
ancestry


mlbook_red$female_dum = mlbook_red$sex
mlbook_red$minority_dum = mlbook_red$Minority
### now effect-code our categorical predictor variables ----
yr4_reg_data$female_eff = as.numeric(car::recode(yr4_reg_data$gender, "1=1;0=-1")) 


```

















```{r}

ggplot(aes(x=prs_one_mhc_val,y=cbcl_scr_syn_aggressive_t),data=eur_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()


ggplot(aes(x=prs_all_mhc_val,y=cbcl_scr_syn_anxdep_t),data=yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_no_mhc_val,y=cbcl_scr_syn_external_t),data=yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_all_mhc_val,y=cbcl_scr_syn_internal_t),data=eur_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_one_mhc_val,y=cbcl_scr_syn_rulebreak_t),data=eur_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_one_mhc_val,y=cbcl_scr_syn_somatic_t),data=amadmix_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_all_mhc_val,y=cbcl_scr_syn_thought_t),data=yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_all_mhc_val,y=cbcl_scr_syn_totprob_t),data=eur_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()

ggplot(aes(x=prs_one_mhc_val,y=cbcl_scr_syn_withdep_t),data=eur_yr4_data_reordered) +
  geom_point(color="gray") +
  geom_smooth() +
  theme_bw()



```